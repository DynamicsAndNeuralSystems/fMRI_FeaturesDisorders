---
title: "Step 6: Pair-wise SPI Feature Analysis"
output: 
  github_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=F, message=F)
```

### Source functions
```{r}
source("../helper_functions/Linear_SVM.R")
source("../helper_functions/Visualization.R")
source("../helper_functions/Null_distributions.R")
rdata_path <- "D:/Virtual_Machines/Shared_Folder/PhD_work/data/scz/UCLA/Rdata/"
rdata_path_for_pyspi <- "D:/Virtual_Machines/Shared_Folder/PhD_work/data/scz/UCLA/pydata/R_files/"
set.seed(127)


study <- "D:/Virtual_Machines/Shared_Folder/PhD_work/"
pydata_path <- paste0(study, "data/scz/UCLA/pydata/AROMA_2P/")
ROI_index <- read.csv(paste0(study, "data/scz/UCLA/pydata/ROI_info.csv"))
SPI_directionality <- read.csv("SPI_Direction_Info.csv")
```


## By individual SPI

Load pyspi data
```{r}
all_pyspi_data <- readRDS(paste0(rdata_path_for_pyspi, "All_subject_pyspi.Rds"))
```

### All SPIs

#### In sample

```{r}
if (!file.exists(paste0(rdata_path, "Pairwise_Linear_SVM_All_ROIs_In_Sample.Rds"))) {
  Pairwise_Linear_SVM_All_ROIs_In_Sample <- run_pairwise_SVM_by_SPI(pairwise_data = all_pyspi_data,
                                                                    svm_kernel = "linear",
                                                                    test_package = "e1071",
                                                                    noise_proc = "AROMA+2P",
                                                                    cross_validate = FALSE,
                                                                    return_all_fold_metrics = FALSE,
                                                                    use_inv_prob_weighting = FALSE,
                                                                    use_SMOTE = FALSE,
                                                                    shuffle_labels = FALSE)
  saveRDS(Pairwise_Linear_SVM_All_ROIs_In_Sample, 
          paste0(rdata_path, "Pairwise_Linear_SVM_All_ROIs_In_Sample.Rds"))
} else {
  Pairwise_Linear_SVM_All_ROIs_In_Sample <- readRDS(paste0(rdata_path,
                                                           "Pairwise_Linear_SVM_All_ROIs_In_Sample.Rds"))
}
```

#### CV

```{r}
if (!file.exists(paste0(rdata_path, "Pairwise_Linear_SVM_All_ROIs_CV.Rds"))) {
  Pairwise_Linear_SVM_All_ROIs_CV <- run_pairwise_SVM_by_SPI(pairwise_data = all_pyspi_data,
                                                                    svm_kernel = "linear",
                                                                    test_package = "e1071",
                                                                    noise_proc = "AROMA+2P",
                                                                    cross_validate = TRUE,
                                                                    return_all_fold_metrics = TRUE,
                                                                    use_inv_prob_weighting = FALSE,
                                                                    use_SMOTE = FALSE,
                                                                    shuffle_labels = FALSE)
  saveRDS(Pairwise_Linear_SVM_All_ROIs_CV, paste0(rdata_path, "Pairwise_Linear_SVM_All_ROIs_CV.Rds"))
} else {
  Pairwise_Linear_SVM_All_ROIs_CV <- readRDS(paste0(rdata_path, "Pairwise_Linear_SVM_All_ROIs_CV.Rds"))
}
```


#### CV -- inv prob

```{r}
if (!file.exists(paste0(rdata_path, "Pairwise_Linear_SVM_All_ROIs_CV_inv_prob.Rds"))) {
  Pairwise_Linear_SVM_All_ROIs_CV_inv_prob <- run_pairwise_SVM_by_SPI(pairwise_data = all_pyspi_data,
                                                                    svm_kernel = "linear",
                                                                    test_package = "e1071",
                                                                    noise_proc = "AROMA+2P",
                                                                    cross_validate = TRUE,
                                                                    return_all_fold_metrics = TRUE,
                                                                    use_inv_prob_weighting = TRUE,
                                                                    use_SMOTE = FALSE,
                                                                    shuffle_labels = FALSE)
  saveRDS(Pairwise_Linear_SVM_All_ROIs_CV_inv_prob, paste0(rdata_path, "Pairwise_Linear_SVM_All_ROIs_CV_inv_prob.Rds"))
} else {
  Pairwise_Linear_SVM_All_ROIs_CV_inv_prob <- readRDS(paste0(rdata_path, "Pairwise_Linear_SVM_All_ROIs_CV_inv_prob.Rds"))
}
```


#### CV -- SMOTE

```{r}
if (!file.exists(paste0(rdata_path, "Pairwise_Linear_SVM_All_ROIs_CV_SMOTE.Rds"))) {
  Pairwise_Linear_SVM_All_ROIs_CV_SMOTE <- run_pairwise_SVM_by_SPI(pairwise_data = all_pyspi_data,
                                                                   svm_kernel = "linear",
                                                                   test_package = "e1071",
                                                                   noise_proc = "AROMA+2P",
                                                                   cross_validate = TRUE,
                                                                    return_all_fold_metrics = TRUE,
                                                                   use_inv_prob_weighting = FALSE,
                                                                   use_SMOTE = TRUE,
                                                                   shuffle_labels = FALSE)
  saveRDS(Pairwise_Linear_SVM_All_ROIs_CV_SMOTE, paste0(rdata_path, "Pairwise_Linear_SVM_All_ROIs_CV_SMOTE.Rds"))
} else {
  Pairwise_Linear_SVM_All_ROIs_CV_SMOTE <- readRDS(paste0(rdata_path, "Pairwise_Linear_SVM_All_ROIs_CV_SMOTE.Rds"))
}
```

Combine results into one table
```{r}
Pairwise_Linear_SVM_All_ROIs_In_Sample$Method <- "In-sample"
Pairwise_Linear_SVM_All_ROIs_CV$Method <- "CV"
Pairwise_Linear_SVM_All_ROIs_CV_inv_prob$Method <- "CV inv prob"
Pairwise_Linear_SVM_All_ROIs_CV_SMOTE$Method <- "CV SMOTE"

pairwise_metrics <- do.call(plyr::rbind.fill, list(Pairwise_Linear_SVM_All_ROIs_In_Sample,
                               Pairwise_Linear_SVM_All_ROIs_CV,
                               Pairwise_Linear_SVM_All_ROIs_CV_inv_prob,
                               Pairwise_Linear_SVM_All_ROIs_CV_SMOTE)) 

mean_pairwise_metrics <- pairwise_metrics %>%
  group_by(SPI, Method) %>%
  summarise(mean_accuracy = mean(accuracy),
            mean_balanced_accuracy = mean(balanced_accuracy)) %>%
  ungroup()
```

heatmaps
```{r}
# Accuracy
mean_pairwise_metrics %>%
  mutate(SPI = fct_reorder(SPI, mean_accuracy, .fun = mean),
         Method = factor(Method, levels = c("In-sample", "CV", 
                                            "CV inv prob", "CV SMOTE"))) %>%
  arrange(SPI) %>%
  ggplot(data=., mapping = aes(x=Method, y=SPI, fill=mean_accuracy)) +
  geom_tile() +
  geom_text(aes(label = round(100*mean_accuracy, 2))) +
  ggtitle("Accuracy by PySPI SPI") +
  scale_fill_gradient(low = "white", high = "red") +
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 10)) +
  theme(legend.position = "none",
        plot.title = element_text(hjust=0.5))
ggsave("plots/PySPI_SPI_Accuracy.png", width=8, height=5, units="in", dpi=300)

# Balanced Accuracy
mean_pairwise_metrics %>%
  mutate(SPI = fct_reorder(SPI, mean_balanced_accuracy, .fun = mean),
         Method = factor(Method, levels = c("In-sample", "CV", 
                                            "CV inv prob", "CV SMOTE"))) %>%
  ggplot(data=., mapping = aes(x=Method, y=SPI, fill=mean_balanced_accuracy)) +
  geom_tile() +
  geom_text(aes(label = round(100*mean_balanced_accuracy, 2))) +
  ggtitle("Balanced Accuracy by PySPI SPI") +
  scale_fill_gradient(low = "white", high = "red") +
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 10)) +
  theme(legend.position = "none",
        plot.title = element_text(hjust=0.5))
ggsave("plots/PySPI_SPI_Balanced_Accuracy.png", width=8, height=5, units="in", dpi=300)
```

Boxplot for each CV method

```{r}
# Accuracy
pairwise_metrics %>%
  filter(Method != "In-sample") %>%
  mutate(SPI = fct_reorder(SPI, accuracy, .fun = mean, .desc=F)) %>%
  ggplot(data=., mapping = aes(y = SPI,
                               x = accuracy)) +
  geom_boxplot(aes(fill = SPI)) +
  xlab("Accuracy") +
  ylab("SPI") +
  ggtitle("CV Accuracy by pySPI SPI") +
  facet_grid(. ~ Method, scales="free_y") +
  theme(legend.position = "none")
ggsave("plots/PySPI_SPI_Accuracy_CV_Boxplots.png", width=10, height=6, units="in", dpi=300)

# Balanced Accuracy
pairwise_metrics %>%
  filter(Method != "In-sample") %>%
  mutate(SPI = fct_reorder(SPI, balanced_accuracy, .fun = mean, .desc=F)) %>%
  ggplot(data=., mapping = aes(y = SPI,
                               x = balanced_accuracy)) +
  geom_boxplot(aes(fill = SPI)) +
  xlab("Balanced Accuracy") +
  ylab("SPI") +
  ggtitle("CV Balanced Accuracy by pySPI SPI")+                                
  facet_grid(. ~ Method, scales="free_y") +
  theme(legend.position = "none")
ggsave("plots/PySPI_SPI_Balanced_Accuracy_CV_Boxplots.png", width=10, height=6, units="in", dpi=300)
```


## By individual pair of regions

## All SPIs and all pairs of regions



