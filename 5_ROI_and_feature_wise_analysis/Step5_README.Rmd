---
title: "Step 5: ROI+Feature Classification Analysis"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=F, message=F)
```

### Source functions
```{r}
source("../helper_functions/in_sample_SVM_code.R")
rdata_path <- "D:/Virtual_Machines/Shared_Folder/PhD_work/data/scz/UCLA/Rdata/"
set.seed(127)
```

## In-sample SVM classification

### Simple in-sample linear SVM

We will start with a simple linear SVM classifier using all 22 features.

```{r}
# Compare all three noise processing methods
noise_procs = c("AROMA+2P", "AROMA+2P+GMR", "AROMA+2P+DiCER")

# SVM param df
svm_df <- data.frame(test_packages = c("e1071", "kernlab"),
                     kernels = c("linear", "vanilladot"))

# Iterate over SVM params
for (i in 1:nrow(svm_df)) {
  test_package = svm_df$test_packages[i]
  kernel = svm_df$kernels[i]
  
  # Run in-sample SVM using given package + kernel
  # If the RDS object doesn't already exist, otherwise load it in
  if (!file.exists(paste0(rdata_path, "multivar_combo_res_svmLinear_in_sample_", test_package, ".Rds"))) {
    combo_wise_SVM_in_sample <- run_in_sample_svm_by_input_var(rdata_path = rdata_path,
                                                                     svm_kernel = kernel,
                                                                     test_package = test_package,
                                                                     noise_procs = noise_procs,
                                                                     svm_feature_var = "Combo",
                                                                     grouping_var = "Combo",
                                                                     use_inv_prob_weighting = FALSE) %>%
      dplyr::rename("accuracy" = "Accuracy",
                    "balanced_accuracy" = "Balanced_Accuracy")
    saveRDS(combo_wise_SVM_in_sample, file=paste0(rdata_path, "multivar_combo_res_svmLinear_in_sample_", test_package, ".Rds"))
  } 
}

```

Let's compare e1071 with kernlab. 

e1071:

```{r, fig.width=7, fig.height=6}
# Plot accuracy + balanced accuracy in histograms
# Control subject proportion is highlighted for accuracy
e1071_combo_wise_SVM_in_sample <- readRDS(paste0(rdata_path, "multivar_combo_res_svmLinear_in_sample_e1071.Rds"))

noise_procs = c("AROMA+2P", "AROMA+2P+GMR", "AROMA+2P+DiCER")
plot_class_acc_w_props(class_res = e1071_combo_wise_SVM_in_sample,
                       cv = FALSE,
                       rdata_path = rdata_path,
                       noise_procs = noise_procs)
```

```{r, eval=F, echo=F}
# Save plot
ggsave("plots/In_Sample_Combo_Wise_linear_SVM_Multivar_e1071.png",
       width=7, height=6, units="in", dpi=300)
```

kernlab:

```{r, fig.width=7, fig.height=6}
# Plot accuracy + balanced accuracy in histograms
# Control subject proportion is highlighted for accuracy
kernlab_combo_wise_SVM_in_sample <- readRDS(paste0(rdata_path, "multivar_combo_res_svmLinear_in_sample_kernlab.Rds"))

noise_procs = c("AROMA+2P", "AROMA+2P+GMR", "AROMA+2P+DiCER")
plot_class_acc_w_props(class_res = kernlab_combo_wise_SVM_in_sample,
                       cv = FALSE,
                       rdata_path = rdata_path,
                       noise_procs = noise_procs)
```

```{r, eval=F, echo=F}
# Save plot
ggsave("plots/In_Sample_combo_wise_linear_SVM_Multivar_kernlab.png",
       width=7, height=6, units="in", dpi=300)
```



### In-sample linear SVM with inverse probability weighting

We can run linear SVM with the `kernlab` package to directly test sample reweighting with in-sample accuracy and balanced accuracy. 

```{r}
# Compare all three noise processing methods
noise_procs = c("AROMA+2P", "AROMA+2P+GMR", "AROMA+2P+DiCER")

# SVM param df
svm_df <- data.frame(test_packages = c("e1071", "kernlab"),
                     kernels = c("linear", "vanilladot"))

# Iterate over SVM params
for (i in 1:nrow(svm_df)) {
  test_package = svm_df$test_packages[i]
  kernel = svm_df$kernels[i]
  
  # Run in-sample SVM using given package + kernel
  # If the RDS object doesn't already exist, otherwise load it in
  if (!file.exists(paste0(rdata_path, "multivar_combo_res_svmLinear_in_sample_", test_package, "_inv_prob.Rds"))) {
    combo_wise_SVM_in_sample_inv_prob <- run_in_sample_svm_by_input_var(rdata_path = rdata_path,
                                                                     svm_kernel = kernel,
                                                                     test_package = test_package,
                                                                     noise_procs = noise_procs,
                                                                     svm_feature_var = "Combo",
                                                                     grouping_var = "Combo",
                                                                     use_inv_prob_weighting = TRUE) %>%
      dplyr::rename("accuracy" = "Accuracy",
                    "balanced_accuracy" = "Balanced_Accuracy")
    saveRDS(combo_wise_SVM_in_sample_inv_prob, file=paste0(rdata_path, "multivar_combo_res_svmLinear_in_sample_", test_package, "_inv_prob.Rds"))
  } 
}

```

Let's compare e1071 with kernlab. 

e1071:

```{r, fig.width=7, fig.height=6}
# Plot accuracy + balanced accuracy in histograms
# Control subject proportion is highlighted for accuracy
e1071_combo_wise_SVM_in_sample_inv_prob <- readRDS(paste0(rdata_path, "multivar_combo_res_svmLinear_in_sample_e1071_inv_prob.Rds"))

noise_procs = c("AROMA+2P", "AROMA+2P+GMR", "AROMA+2P+DiCER")
plot_class_acc_w_props(class_res = e1071_combo_wise_SVM_in_sample_inv_prob,
                       cv = FALSE,
                       rdata_path = rdata_path,
                       noise_procs = noise_procs)
```

```{r, eval=F, echo=F}
# Save plot
ggsave("plots/In_Sample_combo_wise_linear_SVM_Multivar_e1071_inv_prob.png",
       width=7, height=6, units="in", dpi=300)
```

kernlab:

```{r, fig.width=7, fig.height=6}
# Plot accuracy + balanced accuracy in histograms
# Control subject proportion is highlighted for accuracy
kernlab_combo_wise_SVM_in_sample_inv_prob <- readRDS(paste0(rdata_path, "multivar_combo_res_svmLinear_in_sample_kernlab_inv_prob.Rds"))

noise_procs = c("AROMA+2P", "AROMA+2P+GMR", "AROMA+2P+DiCER")
plot_class_acc_w_props(class_res = kernlab_combo_wise_SVM_in_sample_inv_prob,
                       cv = FALSE,
                       rdata_path = rdata_path,
                       noise_procs = noise_procs)
```

```{r, eval=F, echo=F}
# Save plot
ggsave("plots/In_Sample_combo_wise_linear_SVM_Multivar_kernlab_inv_prob.png",
       width=7, height=6, units="in", dpi=300)
```



By assigning each subject a weight equivalent to the inverse proportion of that subject's diagnosis, the linear SVM places a higher cost on incorrectly classifying schizophrenia subjects as controls. 

This shifts the raw accuracy down to a mean of around 0.68 across the three noise-processing methods, but the balanced accuracy increases to have an average of around 0.68 also -- compared with almost exclusively values of 0.35 previously.

This indicates that inverse probability reweighting mitigates the class imbalance issue and can be carried forward into 10-fold cross-validation linear SVM.

## Cross-validated SVM classification

### 10-fold cross-validated linear SVM

We can implement 10-fold cross-validation (CV) with the `caret` package.

```{r}
# Noise processing methods
noise_procs <- c("AROMA+2P", "AROMA+2P+GMR", "AROMA+2P+DiCER")
# SVM param df
svm_df <- data.frame(test_packages = c("e1071", "kernlab"),
                     kernels = c("linear", "vanilladot"))

# Iterate over SVM params
for (i in 1:nrow(svm_df)) {
  test_package = svm_df$test_packages[i]
  kernel = svm_df$kernels[i]
  
  # Run in-sample SVM using given package + kernel
  # If the RDS object doesn't already exist, otherwise load it in
  if (!file.exists(paste0(rdata_path, "combo_wise_multi_ROI_svmLinear_CV_", test_package, ".Rds"))) {
    combo_wise_SVM_CV <- run_cv_svm_by_input_var(rdata_path = rdata_path,
                                                               svm_kernel = kernel,
                                                               test_package = test_package,
                                                               svm_feature_var = "Combo",
                                                               grouping_var = "Combo",
                                                               noise_procs = noise_procs,
                                                               use_inv_prob_weighting = TRUE) %>%
    dplyr::rename("accuracy" = "Accuracy",
                  "balanced_accuracy" = "Balanced_Accuracy")
    saveRDS(combo_wise_SVM_CV, file=paste0(rdata_path, "combo_wise_multi_ROI_svmLinear_CV_", test_package, ".Rds"))
  }
}
```

e1071:
```{r, fig.width=7, fig.height=6}
# Plot accuracy + balanced accuracy in histograms
# Control subject proportion is highlighted for accuracy
noise_procs = c("AROMA+2P", "AROMA+2P+GMR", "AROMA+2P+DiCER")
e1071_combo_wise_SVM_CV <- readRDS(paste0(rdata_path, "combo_wise_multi_ROI_svmLinear_CV_e1071.Rds"))

plot_class_acc_w_props(class_res = e1071_combo_wise_SVM_CV,
                       cv = TRUE,
                       rdata_path = rdata_path,
                       noise_procs = noise_procs)
```

```{r, echo=F, eval=F}
# Save plot
ggsave("plots/Combo_Wise_Linear_SVM_CV_e1071.png",
       width=7, height=6, units="in", dpi=300)
```

kernlab:
```{r, fig.width=7, fig.height=6}
# Plot accuracy + balanced accuracy in histograms
# Control subject proportion is highlighted for accuracy
noise_procs = c("AROMA+2P", "AROMA+2P+GMR", "AROMA+2P+DiCER")
kernlab_combo_wise_SVM_CV <- readRDS(paste0(rdata_path, "combo_wise_multi_ROI_svmLinear_CV_kernlab.Rds"))


plot_class_acc_w_props(class_res = kernlab_combo_wise_SVM_CV,
                       cv = TRUE,
                       rdata_path = rdata_path,
                       noise_procs = noise_procs)
```

```{r, echo=F, eval=F}
# Save plot
ggsave("plots/Combo_Wise_Linear_SVM_CV_kernlab.png",
       width=7, height=6, units="in", dpi=300)
```

As with in-sample SVM, the unweighted input samples are virtually all classified as control subjects across all 82 ROIs using the 10-fold cross-validation linear SVM with caret.

### 10-fold cross-validated linear SVM with inverse probability weighting

```{r}
# Try three different noise processing methods
noise_procs = c("AROMA+2P", "AROMA+2P+GMR", "AROMA+2P+DiCER")

# SVM param df
svm_df <- data.frame(test_packages = c("e1071", "kernlab"),
                     kernels = c("linear", "vanilladot"))

# Iterate over SVM params
for (i in 1:nrow(svm_df)) {
  test_package = svm_df$test_packages[i]
  kernel = svm_df$kernels[i]
  
  # Run theft's multivariable classifier on each ROI and save to an RDS object
  # If the RDS object doesn't already exist, otherwise load it in
  if (!file.exists(paste0(rdata_path, "combo_wise_multi_ROI_svmLinear_CV_", test_package, "_inv_prob.Rds"))) {
    
    combo_wise_SVM_CV_inv_prob <- run_cv_svm_by_input_var(rdata_path = rdata_path,
                                                                      svm_kernel = kernel,
                                                                      test_package = test_package,
                                                                      svm_feature_var = "Combo",
                                                                      grouping_var = "Combo",
                                                                      noise_procs = noise_procs,
                                                                      use_inv_prob_weighting = TRUE)  %>%
      dplyr::rename("accuracy" = "Accuracy",
                    "balanced_accuracy" = "Balanced_Accuracy")
    
    saveRDS(combo_wise_SVM_CV_inv_prob, file=paste0(rdata_path, "combo_wise_multi_ROI_svmLinear_CV_", test_package, "_inv_prob.Rds"))
  } 
}
```

e1071
```{r, fig.width=7, fig.height=6}
noise_procs = c("AROMA+2P", "AROMA+2P+GMR", "AROMA+2P+DiCER")
e1071_combo_wise_SVM_CV_inv_prob <- readRDS(paste0(rdata_path, "combo_wise_multi_ROI_svmLinear_CV_e1071.Rds"))

plot_class_acc_w_props(class_res = e1071_combo_wise_SVM_CV_inv_prob,
                       cv = TRUE,
                       rdata_path = rdata_path,
                       noise_procs = noise_procs)
```
```{r, eval=F, echo=F}
# Save plot
ggsave("plots/Combo_Wise_Linear_SVM_CV_e1071_inv_prob.png",
       width=7, height=6, units="in", dpi=300)
```

kernlab
```{r, fig.width=7, fig.height=6}
kernlab_combo_wise_SVM_CV_inv_prob <- readRDS(paste0(rdata_path, "combo_wise_multi_ROI_svmLinear_CV_kernlab.Rds"))

plot_class_acc_w_props(class_res = kernlab_combo_wise_SVM_CV_inv_prob,
                       cv = TRUE,
                       rdata_path = rdata_path,
                       noise_procs = noise_procs)
```

```{r, eval=F, echo=F}
# Save plot
ggsave("plots/Combo_Wise_Linear_SVM_CV_kernlab_inv_prob.png",
       width=7, height=6, units="in", dpi=300)
```

Surprisingly, incorporating inverse probability weighting has minimal impact when it comes to the ten-fold cross-validated SVM. Of note, the in-sample and cross-validated SVM were both run with kernlab::ksvm using default parameters.

## Null models

### Generating null distributions from model-free shuffles

```{r}
# Try three different noise processing methods
noise_procs = c("AROMA+2P", "AROMA+2P+GMR", "AROMA+2P+DiCER")

# One without minority upsampling
if (!file.exists(paste0(rdata_path, "Null_Model_Free_Shuffles.Rds"))) {
  set.seed(127) 
  model_free_shuffle_null_res <- run_model_free_n_shuffles(num_shuffles = 1000000,
                                                    rdata_path = rdata_path,
                                                    noise_procs = noise_procs)
  saveRDS(model_free_shuffle_null_res, file = paste0(rdata_path, "Null_Model_Free_Shuffles.Rds"))
} else {
  model_free_shuffle_null_res <- readRDS(paste0(rdata_path, "Null_Model_Free_Shuffles.Rds"))
}
```

### Deriving p-values using model-free shuffle null distributions

```{r}
if (!file.exists(paste0(rdata_path, "UCLA_combo_wise_SVM_caret_upsampled_pvals.Rds"))) {
  e1071_combo_wise_SVM_CV_pvals <- calc_empirical_nulls(class_res = e1071_combo_wise_SVM_CV,
                                                        null_data = model_free_shuffle_null_res,
                                                        grouping_var = "All")
  saveRDS(e1071_combo_wise_SVM_CV_pvals, file=paste0(rdata_path, "UCLA_combo_wise_SVM_caret_upsampled_pvals.Rds"))
  
} else {
  e1071_combo_wise_SVM_CV_pvals <- readRDS(paste0(rdata_path, "UCLA_combo_wise_SVM_caret_upsampled_pvals.Rds"))
}

e1071_combo_wise_SVM_CV_plabs <- e1071_combo_wise_SVM_CV_pvals %>%
  mutate(acc_p = scales::scientific(acc_p, digits = 3),
         bal_acc_p = scales::scientific(bal_acc_p, digits = 3),
         acc_p_adj = scales::scientific(acc_p_adj, digits = 3),
         bal_acc_p_adj = scales::scientific(bal_acc_p_adj, digits = 3))
```

Accuracy:
```{r, fig.width=7, fig.height=6}
e1071_combo_wise_SVM_CV_pvals %>%
  ggplot(data=.) +
  geom_histogram(data = subset(model_free_shuffle_null_res, Type=="null"),
                 aes(x = accuracy, y=0.5*..density..), 
                 bins = 50,
                 alpha=0.6, position="identity",
                 fill = "gray70") +
  geom_vline(mapping=aes(xintercept = accuracy, color = Noise_Proc), size=1.2) +
  xlab("Accuracy from n=1,000,000 Model-Free Shuffles") +
  ylab("Scaled Density") +
  labs(color = "Noise Processing") +
  theme(strip.text.y.left = element_text(angle=0),
        strip.placement = "outside",
        legend.position = "bottom",
        legend.direction = "horizontal")
```

```{r, eval=F, echo=F}
# Save plot
ggsave("plots/Main_vs_Null_Acc_10FCV_Linear_SVM_combo_wise.png",
       width=8, height=5, units="in", dpi=300)
```

Balanced accuracy:
```{r, fig.width=7, fig.height=6}
e1071_combo_wise_SVM_CV_pvals %>%
  ggplot(data=.) +
  geom_histogram(data = subset(model_free_shuffle_null_res, Type=="null"),
                 aes(x = balanced_accuracy, y=0.5*..density..), 
                 bins = 50,
                 alpha=0.6, position="identity",
                 fill = "gray70") +
  geom_vline(mapping=aes(xintercept = balanced_accuracy, color = Noise_Proc), size=1.2) +
  xlab("Balanced Accuracy from n=1,000,000 Model-Free Shuffles") +
  ylab("Scaled Density") +
  labs(color = "Noise Processing") +
  theme(strip.text.y.left = element_text(angle=0),
        strip.placement = "outside",
        legend.position = "bottom",
        legend.direction = "horizontal")
```

```{r, eval=F, echo=F}
# Save plot
ggsave("plots/Main_vs_Null_BAcc_10FCV_Linear_SVM_combo_wise.png",
       width=8, height=5, units="in", dpi=300)
```

Summary statistics:
```{r}
e1071_combo_wise_SVM_CV_plabs %>%
  mutate(Noise_Proc = factor(Noise_Proc, levels = noise_procs)) %>%
  arrange(Noise_Proc)
```



