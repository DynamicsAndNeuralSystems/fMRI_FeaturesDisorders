---
title: "Step 2: Quality Control"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.show = 'hold')
```


```{r}
### Source functions
source("../helper_functions/QC_functions.R")

theme_set(cowplot::theme_cowplot())
data_path <- "D:/Virtual_Machines/Shared_Folder/PhD_work/data/scz/UCLA/"
rdata_path <- paste0(data_path, "Rdata/")

# Compare all three noise processing methods
noise_procs = c("AROMA+2P", "AROMA+2P+GMR", "AROMA+2P+DiCER")
```

# Univariate

## catch22 


One thing to look at is subjects with NA for all ROIs for all catch22 features.

```{r}
catch22_NA_subjects <- find_univariate_subject_na(rdata_path = rdata_path,
                                               feature_set = "catch22")
catch22_NA_subjects
```

This shows that there are six subjects for whom catch22 returned NA values for all ROIs (82) for 19 out of the 22 features. We can load in the raw time-series datasets and view the raw values for these subjects.

```{r}
plot_NA_subject_ts(rdata_path=rdata_path, 
                   subject_IDs=catch22_NA_subjects$Subject_ID)

ggsave("plots/Raw_fMRI_Signal_NA_Subjects_catch22.png",
       width=7, height=6, units="in", dpi=300)
```

I will omit these six subjects from the catch22 data going forward.

```{r}
for (noise_proc in noise_procs) {
  noise_label <- gsub("\\+", "_", noise_proc)
  if (!file.exists(paste0(rdata_path, 
                          sprintf("UCLA_%s_%s_zscored_filtered.Rds",
                                  noise_label,
                                  feature_set)))) {
    TS_feature_df_filtered <- readRDS(paste0(rdata_path, sprintf("UCLA_%s_%s_zscored.Rds",
                                                                 noise_label,
                                                                 feature_set))) %>%
      mutate(Noise_Proc = noise_proc) %>%
      dplyr::filter(!(Subject_ID %in% catch22_NA_subjects$Subject_ID))
    
    saveRDS(TS_feature_df_filtered, file = paste0(rdata_path, 
                                                  sprintf("UCLA_%s_%s_zscored_filtered.Rds",
                                                          noise_label,
                                                          feature_set)))
  }
}
```

We can save a dataframe containing the filtered subjects and their diagnoses:

```{r}
noise_label = "AROMA_2P"
filtered_subject_info <- readRDS(paste0(rdata_path, 
                                        sprintf("UCLA_%s_%s_zscored_filtered.Rds",
                                                noise_label,
                                                feature_set))) %>%
  distinct(Subject_ID, group)
saveRDS(filtered_subject_info, file=paste0(rdata_path, "Filtered_subject_info_catch22.Rds"))
```

### Movement -- fractional displacement

We can compile the subjects' average fractional displacement (FD) in the scanner into a dataframe:
```{r}
movement_data <- compile_movement_data(fd_path=paste0(data_path, "movementData/"),
                                       subject_csv = paste0(data_path, "participants.csv"))

head(movement_data)
```
Visualize the average FD by diagnosis in a boxplot:
```{r}
plot_FD_vs_diagnosis(movement_data = movement_data)
```
```{r, echo=F, eval=F}
ggsave("plots/Subject_FD_by_Diagnosis.png",
       width=4, height=4, units="in", dpi=300)
```

Plot the number of subjects retained at each FD threshold:
```{r}
plot_subjects_per_fd_threshold(movement_data)
```
```{r, echo=F, eval=F}
ggsave("plots/Subjects_Retained_by_FD_Threshold.png",
       width=5, height=4, units="in", dpi=300)
```

```{r}
fd_thresh_list <- list()
for (fd_threshold in seq(0, 1, by=0.01)) {
  num_ctrl = nrow(subset(movement_data, FD <= fd_threshold & diagnosis=="CONTROL"))
  num_schz = nrow(subset(movement_data, FD <= fd_threshold & diagnosis=="SCHZ"))
  thresh_df <- data.frame(FD_Threshold = fd_threshold,
                          Control = num_ctrl,
                          Schizophrenia = num_schz)
  fd_thresh_list <- rlist::list.append(fd_thresh_list, thresh_df)
}
threshold_data <- do.call(plyr::rbind.fill, fd_thresh_list) %>%
  mutate(SCZ_to_CTRL = Schizophrenia / Control)

threshold_data %>%
  ggplot(data=., mapping=aes(x=FD_Threshold, y=SCZ_to_CTRL)) +
  geom_line(size=2) +
  ylab("SCZ:CTRL Ratoi") +
  xlab("FD Threshold") +
  scale_x_reverse() +
  ggtitle("Ratio of SCZ:CTRL Subjects Retained\nby FD Threshold") +
  theme(legend.position="bottom",
        plot.title=element_text(hjust=0.5))

ggsave("plots/SCZ_to_CTRL_Retained_by_FD_Threshold.png",
       width=5, height=4, units="in", dpi=300)
```



## catchaMouse16 

First, I'll look for feature(s) that are NA across all subjects:

```{r}
catchaMouse16_NA_features <- find_univariate_feature_na(rdata_path = rdata_path,
                                                        feature_set = "catchaMouse16",
                                                        noise_procs = noise_procs)

catchaMouse16_NA_features
```

The feature `ST_LocalExtrema_n100_diffmaxabsmin` returned all NA values for all subjects and brain regions, so this feature will be dropped.  I'll also check to see which subjects have NA for all catchaMouse16 features:

```{r}
catchaMouse16_NA_subjects <- find_univariate_subject_na(rdata_path = rdata_path,
                                               feature_set = "catchaMouse16")
catchaMouse16_NA_subjects
```
This shows that there are six subjects for whom catchaMouse16 returned NA values for all ROIs (82) for all 16 features. We can load in the raw time-series datasets and view the raw values for these subjects.

```{r}
plot_NA_subject_ts(rdata_path=rdata_path, 
                   NA_subject_IDs=catchaMouse16_NA_subjects$Subject_ID)

ggsave("plots/Raw_fMRI_Signal_NA_Subjects_catchaMouse16.png",
       width=7, height=6, units="in", dpi=300)
```

I will omit these six subjects from the catchaMouse16 data going forward.

```{r}
feature_set = "catchaMouse16"
for (noise_proc in noise_procs) {
  noise_label <- gsub("\\+", "_", noise_proc)
  if (!file.exists(paste0(rdata_path, 
                          sprintf("UCLA_%s_%s_zscored_filtered.Rds",
                                  noise_label,
                                  feature_set)))) {
    TS_feature_df_filtered <- readRDS(paste0(rdata_path, sprintf("UCLA_%s_%s_zscored.Rds",
                                                                 noise_label,
                                                                 feature_set))) %>%
      mutate(Noise_Proc = noise_proc) %>%
      dplyr::filter(!(Subject_ID %in% catchaMouse16_NA_subjects$Subject_ID),
                    !(names %in% catchaMouse16_NA_features$names))
    
    saveRDS(TS_feature_df_filtered, file = paste0(rdata_path, 
                                                  sprintf("UCLA_%s_%s_zscored_filtered.Rds",
                                                          noise_label,
                                                          feature_set)))
  }
}
```

We can save a dataframe containing the filtered subjects and their diagnoses:

```{r}
noise_label = "AROMA_2P"
feature_set = "catchaMouse16"
filtered_subject_info <- readRDS(paste0(rdata_path, 
                                        sprintf("UCLA_%s_%s_zscored_filtered.Rds",
                                                noise_label,
                                                feature_set))) %>%
  distinct(Subject_ID, group)
saveRDS(filtered_subject_info, file=paste0(rdata_path, 
                                           sprintf("Filtered_subject_info_%s.Rds",
                                                   feature_set)))
```


# Pairwise

## pySPI

### NA values
