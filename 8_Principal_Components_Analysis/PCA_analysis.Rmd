---
title: "PCA analysis"
author: "Annie Bryant"
date: "5/8/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
github_dir <- "D:/Virtual_Machines/Shared_Folder/github/fMRI_FeaturesDisorders/"
source(paste0(github_dir, "helper_functions/Linear_SVM.R"))
source(paste0(github_dir, "helper_functions/Visualization.R"))
source(paste0(github_dir, "helper_functions/Null_distributions.R"))
rdata_path <- "D:/Virtual_Machines/Shared_Folder/PhD_work/data/scz/UCLA/Rdata/"

# TO-DO: abstract out PCA functions to a helper script
library(FactoMineR)
library(factoextra)

noise_proc = "AROMA+2P"
# Clean up names
noise_label <- gsub("\\+", "_", noise_proc)

# Load catch22 data for current noise processing method
feature_matrix <- readRDS(paste0(rdata_path, sprintf("UCLA_%s_catch22.Rds", 
                                                     noise_label)))      
```

## Step 3

AROMA + 2P

```{r}
eigen_list <- list()
for (brain_region in unique(feature_matrix$Brain_Region)) {
  region_data <- subset(feature_matrix, Brain_Region == brain_region) %>%
    pivot_wider(id_cols = c(Subject_ID, group, Brain_Region),
                names_from = names,
                values_from = values)
  region_data_mat <- region_data %>%
    select(-Subject_ID, -group, -Brain_Region) %>%
    drop_na() %>%
    as.matrix()
  region_data_PCA <- prcomp(region_data_mat, center = TRUE, scale. = TRUE)
  
  region_eigen  <- get_eig(region_data_PCA) %>%
    mutate(Components = 1:nrow(.)) %>%
    dplyr::rename("Percent_Variance" = "variance.percent",
                  "Cumulative_Variance" = "cumulative.variance.percent") %>%
    mutate(Brain_Region = brain_region)
  
  eigen_list <- rlist::list.append(eigen_list, region_eigen)
}

eigen_df <- do.call(plyr::rbind.fill, eigen_list)
```

```{r}
eigen_df %>%
  ggplot(data = ., mapping = aes(x=Components, y=Cumulative_Variance)) +
  geom_point() +
  geom_line(aes(group = Brain_Region), alpha = 0.5) +
  ylab("Percent Variance") +
  xlab("Number of PCs") +
  ggtitle("Region-wise PCA Cumulative Variance") +
  theme(plot.title = element_text(hjust = 0.5))
```



## Step 4

AROMA + 2P

```{r}
feature_PCA_list <- list()
feature_PC_scores_list <- list()
feature_eigen_list <- list()

for (catch22_feature in unique(feature_matrix$names)) {
  feature_data <- subset(feature_matrix, names == catch22_feature) %>%
    pivot_wider(id_cols = c(Subject_ID, group, names),
                names_from = Brain_Region,
                values_from = values) %>%
    drop_na()
  feature_data_mat <- feature_data %>%
    select(-Subject_ID, -group, -names) %>%
    as.matrix()
  
  feature_data_PCA <- prcomp(feature_data_mat, center = TRUE, scale. = TRUE)
  feature_PCA_list[[catch22_feature]] <- feature_data_PCA
  
  feature_PC_vals <- as.data.frame(feature_data_PCA$x)
  feature_PC_vals$group <- feature_data$group
  feature_PC_vals$feature <- catch22_feature
  feature_PC_scores_list <- rlist::list.append(feature_PC_scores_list, feature_PC_vals)
  
  feature_eigen  <- get_eig(feature_data_PCA) %>%
    mutate(Components = 1:nrow(.)) %>%
    dplyr::rename("Percent_Variance" = "variance.percent",
                  "Cumulative_Variance" = "cumulative.variance.percent") %>%
    mutate(catch22_Feature = catch22_feature)
  
  feature_eigen_list <- rlist::list.append(feature_eigen_list, feature_eigen)
}

feature_eigen_df <- do.call(plyr::rbind.fill, feature_eigen_list)
feature_PC_scores <- do.call(plyr::rbind.fill, feature_PC_scores_list)
```

```{r}
feature_eigen_df %>%
  ggplot(data = ., mapping = aes(x=Components, y=Cumulative_Variance)) +
  geom_point() +
  geom_line(aes(group = catch22_Feature), alpha = 0.5) +
  ylab("Cumulative Variance") +
  xlab("Number of PCs") +
  ggtitle("Feature-wise PCA Cumulative Variance") +
  theme(plot.title = element_text(hjust = 0.5))
```

Iterate through every 3 PCs from 1 to 82 to see to see at what point in-sample linear SVM reaches 100% accuracy per catch22 feature:

```{r}
if (!file.exists(paste0(rdata_path, "Feature_wise_PCA_linear_SVM_in_sample.Rds"))) {
  Feature_wise_in_sample_SVM_by_PC_list <- list()
  
  # Iterate over each catch22 feature
  for (this_feature in unique(feature_matrix$names)) {
    
    # Subset feature data from overall PCA results
    groups <- feature_PC_scores %>%
      filter(feature == this_feature) %>%
      pull(group)
    
    # Run SVM for current feature
    df_res <- run_SVM_from_PCA(
      PCA_res = feature_PCA_list[[this_feature]],
      group_vector = groups,
      cross_validate = FALSE,
      use_inv_prob_weighting = FALSE,
      use_SMOTE = FALSE
    ) %>%
      mutate(catch22_feature = this_feature)
    
    # Append this feature's linear SVM results to list
    Feature_wise_in_sample_SVM_by_PC_list <- rlist::list.append(Feature_wise_in_sample_SVM_by_PC_list,
                                                                         df_res)
  }
    # Combine SVM results across features
  Feature_wise_PCA_linear_SVM_in_sample <- do.call(plyr::rbind.fill, Feature_wise_in_sample_SVM_by_PC_list)
  
  saveRDS(Feature_wise_PCA_linear_SVM_in_sample, paste0(rdata_path, "Feature_wise_PCA_linear_SVM_in_sample.Rds"))
} else {
  Feature_wise_PCA_linear_SVM_in_sample <- readRDS(paste0(rdata_path, "Feature_wise_PCA_linear_SVM_in_sample.Rds"))
}
```


Let's see where balanced accuracy starts to hit 100% across the 22 features:
```{r}
Feature_wise_PCA_linear_SVM_in_sample %>%
  ggplot(data=., mapping=aes(x = Num_PCs, y = balanced_accuracy)) +
  geom_point() +
  geom_line(aes(group = catch22_feature)) +
  ylab("In-Sample Balanced Accuracy") +
  xlab("# PCs Used in Linear SVM") +
  ggtitle("In-Sample Linear SVM with Feature-wise PCA") +
  theme(plot.title = element_text(hjust=0.5))
```

For the sake of comparison, I'll do this for inverse probability weighting as well:

```{r}
if (!file.exists(paste0(rdata_path, "Feature_wise_PCA_linear_SVM_in_sample_inv_prob.Rds"))) {
  Feature_wise_in_sample_SVM_inv_prob_by_PC_list <- list()
  
  # Iterate over each catch22 feature
  for (this_feature in unique(feature_matrix$names)) {
    
    # Subset feature data from overall PCA results
    groups <- feature_PC_scores %>%
      filter(feature == this_feature) %>%
      pull(group)
    
    # Run SVM for current feature
    df_res <- run_SVM_from_PCA(
      PCA_res = feature_PCA_list[[this_feature]],
      group_vector = groups,
      cross_validate = FALSE,
      use_inv_prob_weighting = TRUE,
      use_SMOTE = FALSE
    ) %>%
      mutate(catch22_feature = this_feature)
    
    # Append this feature's linear SVM results to list
    Feature_wise_in_sample_SVM_inv_prob_by_PC_list <- rlist::list.append(Feature_wise_in_sample_SVM_inv_prob_by_PC_list,
                                                                         df_res)
  }

  # Combine SVM results across features
  Feature_wise_PCA_linear_SVM_in_sample_inv_prob <- do.call(plyr::rbind.fill, Feature_wise_in_sample_SVM_inv_prob_by_PC_list)
  saveRDS(Feature_wise_PCA_linear_SVM_in_sample_inv_prob, paste0(rdata_path, "Feature_wise_PCA_linear_SVM_in_sample_inv_prob.Rds"))
} else {
  Feature_wise_PCA_linear_SVM_in_sample_inv_prob <- readRDS(paste0(rdata_path, "Feature_wise_PCA_linear_SVM_in_sample_inv_prob.Rds"))
}
```

```{r}
Feature_wise_PCA_linear_SVM_in_sample_inv_prob %>%
  ggplot(data=., mapping=aes(x = Num_PCs, y = balanced_accuracy)) +
  geom_point() +
  geom_line(aes(group = catch22_feature)) +
  ylab("In-Sample Inv Prob Balanced Accuracy") +
  xlab("# PCs Used in Linear SVM") +
  ggtitle("In-Sample Inv Prob Linear SVM with Feature-wise PCA") +
  theme(plot.title = element_text(hjust=0.5))
```


We can do the same with cross-validation and inverse probability weighting:
```{r}
if (!file.exists(paste0(rdata_path, "Feature_wise_PCA_linear_SVM_CV_inv_prob.Rds"))) {
  Feature_wise_CV_SVM_by_PC_inv_prob_list <- list()
  
  # Iterate over each catch22 feature
  for (this_feature in unique(feature_matrix$names)) {
    
    # Subset feature data from overall PCA results
    groups <- feature_PC_scores %>%
      filter(feature == this_feature) %>%
      pull(group)
    
    # Run SVM for current feature
    df_res <- run_SVM_from_PCA(
      PCA_res = feature_PCA_list[[this_feature]],
      group_vector = groups,
      cross_validate = TRUE,
      use_inv_prob_weighting = TRUE,
      use_SMOTE = FALSE
    ) %>%
      mutate(catch22_feature = this_feature)
    
    # Append this feature's linear SVM results to list
    Feature_wise_CV_SVM_by_PC_inv_prob_list <- rlist::list.append(Feature_wise_CV_SVM_by_PC_inv_prob_list,
                                                                         df_res)
  }
    # Combine SVM results across features
  Feature_wise_PCA_linear_SVM_CV_inv_prob <- do.call(plyr::rbind.fill, Feature_wise_CV_SVM_by_PC_inv_prob_list)
  
  saveRDS(Feature_wise_PCA_linear_SVM_CV_inv_prob, paste0(rdata_path, "Feature_wise_PCA_linear_SVM_CV_inv_prob.Rds"))
} else {
  Feature_wise_PCA_linear_SVM_CV_inv_prob <- readRDS(paste0(rdata_path, "Feature_wise_PCA_linear_SVM_CV_inv_prob.Rds"))
}
```

```{r}
Feature_wise_PCA_linear_SVM_CV_inv_prob %>%
  ggplot(data=., mapping=aes(x = Num_PCs, y = balanced_accuracy)) +
  geom_point() +
  geom_line(aes(group = catch22_feature)) +
  ylab("CV Inv Prob Mean Balanced Accuracy") +
  xlab("# PCs Used in Linear SVM") +
  ggtitle("CV Inv Prob Linear SVM with Feature-wise PCA") +
  theme(plot.title = element_text(hjust=0.5))
```

And with SMOTE
```{r}
if (!file.exists(paste0(rdata_path, "Feature_wise_PCA_linear_SVM_CV_SMOTE.Rds"))) {
  Feature_wise_CV_SMOTE_SVM_by_PC_list <- list()
  
  # Iterate over each catch22 feature
  for (this_feature in unique(feature_matrix$names)) {
    
    # Subset feature data from overall PCA results
    groups <- feature_PC_scores %>%
      filter(feature == this_feature) %>%
      pull(group)
    
    # Run SVM for current feature
    df_res <- run_SVM_from_PCA(
      PCA_res = feature_PCA_list[[this_feature]],
      group_vector = groups,
      cross_validate = TRUE,
      use_inv_prob_weighting = FALSE,
      use_SMOTE = TRUE
    ) %>%
      mutate(catch22_feature = this_feature)
    
    # Append this feature's linear SVM results to list
    Feature_wise_CV_SMOTE_SVM_by_PC_list <- rlist::list.append(Feature_wise_CV_SMOTE_SVM_by_PC_list,
                                                                         df_res)
  }
    # Combine SVM results across features
  Feature_wise_PCA_linear_SVM_CV_SMOTE <- do.call(plyr::rbind.fill, Feature_wise_CV_SMOTE_SVM_by_PC_list)
  
  saveRDS(Feature_wise_PCA_linear_SVM_CV_SMOTE, paste0(rdata_path, "Feature_wise_PCA_linear_SVM_CV_SMOTE.Rds"))
} else {
  Feature_wise_PCA_linear_SVM_CV_SMOTE <- readRDS(paste0(rdata_path, "Feature_wise_PCA_linear_SVM_CV_SMOTE.Rds"))
}
```

```{r}
Feature_wise_PCA_linear_SVM_CV_SMOTE %>%
  ggplot(data=., mapping=aes(x = Num_PCs, y = balanced_accuracy)) +
  geom_point() +
  geom_line(aes(group = catch22_feature)) +
  ylab("CV SMOTE Mean Balanced Accuracy") +
  xlab("# PCs Used in Linear SVM") +
  ggtitle("CV SMOTE Linear SVM with Feature-wise PCA") +
  theme(plot.title = element_text(hjust=0.5))
```


Combine all into one plot
```{r}
Feature_wise_PCA_linear_SVM_in_sample$Method <- "In-sample"
Feature_wise_PCA_linear_SVM_in_sample_inv_prob$Method <- "In-sample Inv Prob"
Feature_wise_PCA_linear_SVM_CV_inv_prob$Method <- "CV Inv Prob"
Feature_wise_PCA_linear_SVM_CV_SMOTE$Method <- "CV SMOTE"


mega_df <- do.call(plyr::rbind.fill, list(Feature_wise_PCA_linear_SVM_in_sample,
                                          Feature_wise_PCA_linear_SVM_in_sample_inv_prob,
                                          Feature_wise_PCA_linear_SVM_CV_inv_prob,
                                          Feature_wise_PCA_linear_SVM_CV_SMOTE))

# With smoothing
mega_df %>%
  mutate(Method = factor(Method, levels = c("In-sample",
                                            "In-sample Inv Prob",
                                            "CV",
                                            "CV Inv Prob",
                                            "CV SMOTE")),
         Unique_ID = paste0(Method, "_", catch22_feature)) %>%
  ggplot(data=., mapping = aes(x = Num_PCs, y = balanced_accuracy)) +
  geom_line(aes(group = Unique_ID), color="gray70", alpha=0.1) +
  stat_smooth(geom = "line", aes(group = Method, color = Method)) +
  ggtitle("Balanced Accuracy for catch22 Feature-Wise\nLinear SVM by # PCs (Smoothed)") +
  ylab("Balanced Accuracy") +
  xlab("Number of PCs") +
  labs(color = "Classification\nMethod") +
  theme(plot.title = element_text(hjust=0.5))
```

## Step 5

AROMA + 2P

```{r}
combo_data <- feature_matrix %>%
  tidyr::unite("Combo", Brain_Region, names, sep="_") %>%
  pivot_wider(id_cols = c(Subject_ID, group),
              names_from = Combo,
              values_from = values) %>%
  drop_na() 
combo_data_mat <- combo_data %>%
  select(-Subject_ID, -group) %>%
  as.matrix()

combo_data_PCA <- prcomp(combo_data_mat, center = TRUE, scale. = TRUE)

combo_eigen  <- get_eig(combo_data_PCA) %>%
  mutate(Components = 1:nrow(.)) %>%
  dplyr::rename("Percent_Variance" = "variance.percent",
                "Cumulative_Variance" = "cumulative.variance.percent")

combo_PC_vals <- as.data.frame(combo_data_PCA$x)
combo_PC_vals$group <- combo_data$group
```


Cumulative analysis

```{r}
combo_eigen %>%
  filter(Components < 250) %>%
  ggplot(data = ., mapping = aes(x=Components, y=Cumulative_Variance)) +
  geom_point() +
  geom_line() +
  ylab("Cumulative Variance") +
  xlab("Number of PCs") +
  ggtitle("Combo-wise PCA Cumulative Variance") +
  theme(plot.title = element_text(hjust = 0.5))
```

Run in-sample linear SVM for each number of PCs from 1 to 167
```{r}
if (!file.exists(paste0(rdata_path, "Combo_wise_PCA_linear_SVM_in_sample.Rds"))) {
  Combo_wise_PCA_linear_SVM_in_sample <- run_SVM_from_PCA(
    PCA_res = combo_data_PCA,
    group_vector = combo_data$group,
    cross_validate = FALSE,
    use_inv_prob_weighting = FALSE,
    use_SMOTE = FALSE
  )
  saveRDS(Combo_wise_PCA_linear_SVM_in_sample, paste0(rdata_path, "Combo_wise_PCA_linear_SVM_in_sample.Rds"))
} else {
  Combo_wise_PCA_linear_SVM_in_sample <- readRDS(paste0(rdata_path, "Combo_wise_PCA_linear_SVM_in_sample.Rds"))
}
```

Run in-sample linear SVM with inverse probability weighting for each number of PCs from 1-167
```{r}
if (!file.exists(paste0(rdata_path, "Combo_wise_PCA_linear_SVM_in_sample_inv_prob.Rds"))) {
  
  Combo_wise_PCA_linear_SVM_in_sample_inv_prob <- run_SVM_from_PCA(
    PCA_res = combo_data_PCA,
    group_vector = combo_data$group,
    cross_validate = FALSE,
    use_inv_prob_weighting = TRUE,
    use_SMOTE = FALSE
  )
  saveRDS(Combo_wise_PCA_linear_SVM_in_sample_inv_prob, paste0(rdata_path, "Combo_wise_PCA_linear_SVM_in_sample_inv_prob.Rds"))
} else {
  Combo_wise_PCA_linear_SVM_in_sample_inv_prob <- readRDS(paste0(rdata_path, "Combo_wise_PCA_linear_SVM_in_sample_inv_prob.Rds"))
}
```

Run linear 10-fold SVM for each number of PCs from 1-167
```{r}
if (!file.exists(paste0(rdata_path, "Combo_wise_PCA_linear_SVM_CV.Rds"))) {
  
  Combo_wise_PCA_linear_SVM_CV <- run_SVM_from_PCA(
    PCA_res = combo_data_PCA,
    group_vector = combo_data$group,
    cross_validate = TRUE,
    use_inv_prob_weighting = FALSE,
    use_SMOTE = FALSE
  )
  saveRDS(Combo_wise_PCA_linear_SVM_CV, paste0(rdata_path, "Combo_wise_PCA_linear_SVM_CV.Rds"))
} else {
  Combo_wise_PCA_linear_SVM_CV <- readRDS(paste0(rdata_path, "Combo_wise_PCA_linear_SVM_CV.Rds"))
}
```


Run linear 10-fold CV SVM for each number of PCs from 1 to 167 with inverse probability weighting
```{r}
if (!file.exists(paste0(rdata_path, "Combo_wise_PCA_linear_SVM_CV_inv_prob.Rds"))) {
  Combo_wise_PCA_linear_SVM_CV_inv_prob <- run_SVM_from_PCA(
    PCA_res = combo_data_PCA,
    group_vector = combo_data$group,
    cross_validate = TRUE,
    use_inv_prob_weighting = TRUE,
    use_SMOTE = FALSE
  )
  saveRDS(Combo_wise_PCA_linear_SVM_CV_inv_prob, paste0(rdata_path, "Combo_wise_PCA_linear_SVM_CV_inv_prob.Rds"))
} else {
  Combo_wise_PCA_linear_SVM_CV_inv_prob <- readRDS(paste0(rdata_path, "Combo_wise_PCA_linear_SVM_CV_inv_prob.Rds"))
}
```

Run linear 10-fold CV SVM for each number of PCs from 1 to 167 with SMOTE
```{r}
if (!file.exists(paste0(rdata_path, "Combo_wise_PCA_linear_SVM_CV_SMOTE.Rds"))) {
  
  Combo_wise_PCA_linear_SVM_CV_SMOTE <- run_SVM_from_PCA(
    PCA_res = combo_data_PCA,
    group_vector = combo_data$group,
    cross_validate = TRUE,
    use_inv_prob_weighting = FALSE,
    use_SMOTE = TRUE
  )
  saveRDS(Combo_wise_PCA_linear_SVM_CV_SMOTE, paste0("Combo_wise_PCA_linear_SVM_CV_SMOTE.Rds"))
} else {
  Combo_wise_PCA_linear_SVM_CV_SMOTE <- readRDS(paste0("Combo_wise_PCA_linear_SVM_CV_SMOTE.Rds"))
}
```

```{r}
Combo_wise_PCA_linear_SVM_in_sample$Method <- "In-sample"
Combo_wise_PCA_linear_SVM_in_sample_inv_prob$Method <- "In-sample Inv Prob"
Combo_wise_PCA_linear_SVM_CV$Method <- "CV"
Combo_wise_PCA_linear_SVM_CV_inv_prob$Method <- "CV Inv Prob"
Combo_wise_PCA_linear_SVM_CV_SMOTE$Method <- "CV SMOTE"


mega_df <- do.call(plyr::rbind.fill, list(Combo_wise_PCA_linear_SVM_in_sample,
                                          Combo_wise_PCA_linear_SVM_in_sample_inv_prob,
                                          Combo_wise_PCA_linear_SVM_CV,
                                          Combo_wise_PCA_linear_SVM_CV_inv_prob,
                                          Combo_wise_PCA_linear_SVM_CV_SMOTE))
```

```{r}
# Raw plot
mega_df %>%
  mutate(Method = factor(Method, levels = c("In-sample",
                                            "In-sample Inv Prob",
                                            "CV",
                                            "CV Inv Prob",
                                            "CV SMOTE"))) %>%
  ggplot(data=., mapping = aes(x = Num_PCs, y = balanced_accuracy)) +
  geom_line(aes(group = Method, color = Method)) +
  ggtitle("Balanced Accuracy for Combo-Wise\nLinear SVM by # PCs") +
  ylab("Balanced Accuracy") +
  xlab("Number of PCs") +
  labs(color = "Classification\nMethod") +
  theme(plot.title = element_text(hjust=0.5))
```

```{r}
# With smoothing
mega_df %>%
  mutate(Method = factor(Method, levels = c("In-sample",
                                            "In-sample Inv Prob",
                                            "CV",
                                            "CV Inv Prob",
                                            "CV SMOTE"))) %>%
  ggplot(data=., mapping = aes(x = Num_PCs, y = balanced_accuracy)) +
  geom_line(aes(group = Method), color="gray70", alpha=0.4) +
  stat_smooth(geom = "line", aes(group = Method, color = Method)) +
  ggtitle("Balanced Accuracy for Combo-Wise\nLinear SVM by # PCs (Smoothed)") +
  ylab("Balanced Accuracy") +
  xlab("Number of PCs") +
  labs(color = "Classification\nMethod") +
  theme(plot.title = element_text(hjust=0.5))
```