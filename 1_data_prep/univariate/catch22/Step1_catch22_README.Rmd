---
title: "Step 1: catch22 Data Preparation"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=F, message=F)
```

# fMRI time-series data preparation

The fMRI time-series data (and other metadata) are initially stored in Matlab .mat configuration files. To convert this data into an R-friendly format, please refer to the script load_mat_data.R in this repository.

### Loading .mat data

First, make note of the three R packages needed for this component:  
* `tidyverse`
* `R.matlab`
* `argparse`


Source the data preparation functions:
```{r}
github_dir <- "D:/Virtual_Machines/Shared_Folder/github/fMRI_FeaturesDisorders/"
source(paste0(github_dir, "helper_functions/Data_preparation_univariate.R"))
```

```{r, echo=F}
# Load paths
data_path <- "D:/Virtual_Machines/Shared_Folder/PhD_work/data/scz/UCLA/"
rdata_path <- paste0(data_path, "Rdata/")
mat_file <- "D:/Virtual_Machines/Shared_Folder/PhD_work/data/scz/UCLA/new/UCLA_time_series_four_groups.mat"
subject_csv <- "D:/Virtual_Machines/Shared_Folder/PhD_work/data/scz/UCLA/participants.csv"
```


Run the loading function:
```{r, eval=F}
# Define paths
mat_file = "~/data/UCLA_time_series_four_groups.mat"
subject_csv = "~/data/participants.csv"
rdata_path = "~/data/Rdata/"

# Create Rdata directory if it doesn't already exist
if (!dir.exists(rdata_path)) {
  dir.create(rdata_path)
}

# Run loading function
load_mat_data(mat_file=mat_file, 
              subject_csv=subject_csv, 
              rdata_path=rdata_path, 
              overwrite=FALSE)
```

There should be three new .Rds objects in the Rdata/ subdirectory within your `data_path`, one for each noise processing method:
* AROMA + 2P
* AROMA + 2P + GMR
* AROMA + 2P + DiCER

To explore the data, load one of these into your R workspace using the `readRDS` function (substituting your own data path):

```{r, eval=F}
UCLA_AROMA_2P <- readRDS("~/data/UCLA/Rdata/UCLA_AROMA_2P.Rds")
head(UCLA_AROMA_2P)
```
```{r, echo=F}
UCLA_AROMA_2P_head <- readRDS("D:/Virtual_Machines/Shared_Folder/PhD_work/data/scz/UCLA/Rdata/UCLA_AROMA_2P_head.Rds")
UCLA_AROMA_2P_head
```


### Visualize subject breakdown

The `load_mat_data()` function automatically generates a CSV file containing the list of control and schizophrenia subjects with time-series data ("Rdata/UCLA_subjects_with_TS_data.csv"). 

```{r, eval=F}
get_dx_breakdown("~/data/UCLA/Rdata/UCLA_subjects_with_TS_data.csv")
```

```{r, echo=F, warning=F, message=F}
subject_csv <- "D:/Virtual_Machines/Shared_Folder/PhD_work/data/scz/UCLA/Rdata/UCLA_subjects_with_TS_data.csv"
get_dx_breakdown(subject_csv)
```

To examine the distribution of sex vs. diagnosis, we can use the function `plot_dx_vs_sex_count()`:

```{r, eval=F}
plot_dx_vs_sex_count("~/data/Rdata/UCLA_subjects_with_TS_data.csv")
```
```{r, echo=F}
plot_dx_vs_sex_count(subject_csv)
```
```{r, echo=F, eval=F}
ggsave("plots/Subject_DX_vs_Sex_counts.png",
       width= 5, height = 4, units="in", dpi=300)
```

To examine the distribution of ages across diagnosis:
```{r, eval=F}
plot_dx_vs_sex_age("~/data/Rdata/UCLA_subjects_with_TS_data.csv")
```
```{r, echo=F}
plot_dx_vs_sex_age(subject_csv)
```
```{r, echo=F, eval=F}
ggsave("plots/Subject_DX_vs_Age.png",
       width= 5, height = 4, units="in", dpi=300)
```

### Run catch22 feature extraction

```{r, eval=F}
# Run catch22 on time-series data for each noise processing method
for (noise_proc in c("AROMA+2P", "AROMA+2P+GMR", "AROMA+2P+DiCER")) {
  
  # Clean up noise processing label for file naming
  noise_label <- gsub("\\+", "_", noise_proc)
  
  # Create Rds file for given noise processing method if it doesn't already exist
  if (!file.exists(paste0(rdata_path, sprintf("UCLA_%s_catch22.Rds", 
                                              noise_label)))) {
    
    # Read in time-series data
    TS_df <- readRDS(paste0(rdata_path, sprintf("UCLA_%s.Rds", noise_label)))
    cat("\nNow running catch22 for UCLA", noise_proc, "data.\n")
    
    # Run catch22 on a region-wise basis for all ROIs
    TS_catch22 <- catch22_all_regions(TS_df=TS_df)
    
    # Save resulting time-series features to an .Rds file
    saveRDS(TS_catch22, file=paste0(rdata_path, sprintf("UCLA_%s_catch22.Rds", 
                                                        noise_label)))
    
    remove(TS_df)
  }
  if (!file.exists(paste0(rdata_path, sprintf("UCLA_%s_catch22_zscored.Rds", 
                                              noise_label)))) {
    TS_catch22 <- readRDS(paste0(rdata_path, sprintf("UCLA_%s_catch22.Rds", 
                                                     noise_label)))
    
    # Z-score normalise
    TS_catch22_normed <- normalise_feature_frame(TS_catch22, 
                                                 names_var = "names", 
                                                 values_var = "values", 
                                                 method = "z-score")
    
    # Save resulting z-scored time-series features to an .Rds file
    saveRDS(TS_catch22_normed, file=paste0(rdata_path, sprintf("UCLA_%s_catch22_zscored.Rds", 
                                                               noise_label)))
  }
  # clean up memory
  gc()
}
```