---
title: "README"
author: "Annie Bryant"
date: "3/22/2022"
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# fMRI time-series data preparation

The fMRI time-series data (and other metadata) are initially stored in Matlab .mat configuration files. To convert this data into an R-friendly format, please refer to the script load_mat_data.R in this repository.

### Loading .mat data

First, make note of the three R packages needed for this component:  
* `tidyverse`
* `R.matlab`
* `argparse`


`load_mat_data.R` should be run on the command line and takes the following four arguments:  
* `--mat_file`: Path to the .mat file containing time-series data for the UCLA cohort (i.e. path to "UCLA_time_series_four_groups.mat")
* `--label_metadata`: Path to the .csv file containing metadata about the UCLA cohort subjects (i.e. path to "participants.csv")
* `--data_path`: Path to all UCLA data for this project. The script will automatically create a subdirectory called "Rdata/" if it doesn't already exist.
* `--overwrite`: [*Optional*] Should an Rds object be overwritten if it already exists? Default is False.

Here's an example of how this script might be run:

```
Rscript load_mat_data.R \
--mat_file ~/data/UCLA/new/UCLA_time_series_four_groups.mat \
--label_metadata ~/data/UCLA/participants.csv \
--data_path ~/data/UCLA/
```

There should be three new .Rds objects in the Rdata/ subdirectory within your `data_path`, one for each noise processing method:
* AROMA + 2P
* AROMA + 2P + GMR
* AROMA + 2P + DiCER

To explore the data, load one of these into your R workspace using the `readRDS` function (substituting your own data path):
```
UCLA_AROMA_2P <- readRDS("~/data/UCLA/Rdata/UCLA_AROMA_2P.Rds")
head(UCLA_AROMA_2P)
```

```{r, echo=F}
UCLA_AROMA_2P_head <- readRDS("D:/Virtual_Machines/Shared_Folder/PhD_work/data/scz/UCLA/Rdata/UCLA_AROMA_2P_head.Rds")
UCLA_AROMA_2P_head
```


### Visualize subject breakdown

The `load_mat_data.R` script automatically generates a CSV file containing the list of control and schizophrenia subjects with time-series data ("Rdata/UCLA_subjects_with_TS_data.csv"). 

```
source("subject_info_breakdown.R")
get_dx_breakdown("~/data/UCLA/Rdata/UCLA_subjects_with_TS_data.csv")
```

```{r, echo=F, warning=F, message=F}
source("subject_info_breakdown.R")
subject_csv <- "D:/Virtual_Machines/Shared_Folder/PhD_work/data/scz/UCLA/Rdata/UCLA_subjects_with_TS_data.csv"
get_dx_breakdown(subject_csv)
```

To examine the distribution of sex vs. diagnosis, we can use the function `plot_dx_vs_sex_count()`:

```
plot_dx_vs_sex_count("~/data/UCLA/Rdata/UCLA_subjects_with_TS_data.csv")
```

```{r, echo=F}
plot_dx_vs_sex_count(subject_csv)
```

To examine the distribution of ages across diagnosis:

```
plot_dx_vs_sex_age("~/data/UCLA/Rdata/UCLA_subjects_with_TS_data.csv")
```
```{r, echo=F}
plot_dx_vs_sex_age(subject_csv)
```


### Run catch22 feature extraction

```{r, eval=F}
source("catch22_all_regions.R")
# Run catch22 on time-series data for each noise processing method
for (noise_proc in c("AROMA+2P", "AROMA+2P+GMR", "AROMA+2P+DiCER")) {
  
  # Clean up noise processing label for file naming
  noise_label <- gsub("\\+", "_", noise_proc)
  
  # Create Rds file for given noise processing method if it doesn't already exist
  if (!file.exists(paste0(rdata_path, sprintf("UCLA_%s_catch22.Rds", 
                                              noise_label)))) {
    
    # Read in time-series data
    TS_df <- readRDS(paste0(rdata_path, sprintf("UCLA_%s.Rds", noise_label)))
    cat("\nNow running catch22 for UCLA", noise_proc, "data.\n")
    
    # Run catch22 on a region-wise basis for all ROIs
    TS_catch22 <- catch22_all_regions(TS_df=TS_df)
    
    # Save resulting time-series features to an .Rds file
    saveRDS(TS_catch22, file=paste0(rdata_path, sprintf("UCLA_%s_catch22.Rds", 
                                                        noise_label)))
    remove(TS_df)
  }
  # clean up memory
  gc()
}
```